# Official Structurelint GitHub Action
# Use this workflow as a template for your own projects

name: Structurelint

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint Architecture
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Structurelint
        run: |
          go install github.com/structurelint/structurelint@latest
          # Or use a specific version:
          # go install github.com/structurelint/structurelint@v2.2.0

      - name: Run Structurelint
        run: structurelint --format json > structurelint-results.json
        continue-on-error: true

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: structurelint-results
          path: structurelint-results.json

      - name: Check for violations
        run: |
          if [ -s structurelint-results.json ]; then
            violations=$(jq '. | length' structurelint-results.json)
            if [ "$violations" -gt 0 ]; then
              echo "❌ Found $violations architectural violation(s)"
              structurelint  # Re-run for human-readable output
              exit 1
            fi
          fi
          echo "✓ No architectural violations found"

  # Optional: Auto-fix violations
  autofix:
    name: Auto-fix Violations
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Structurelint
        run: go install github.com/structurelint/structurelint@latest

      - name: Apply auto-fixes
        run: |
          if structurelint fix --dry-run | grep -q "fixable"; then
            structurelint fix --auto
            echo "fixes_applied=true" >> $GITHUB_OUTPUT
          else
            echo "fixes_applied=false" >> $GITHUB_OUTPUT
          fi
        id: autofix

      - name: Commit fixes
        if: steps.autofix.outputs.fixes_applied == 'true'
        run: |
          git config user.name "structurelint-bot"
          git config user.email "bot@structurelint.dev"
          git add -A
          git commit -m "fix: auto-fix architectural violations [structurelint]"
          git push
