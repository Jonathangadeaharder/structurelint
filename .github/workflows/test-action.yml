# Test the Structurelint action against the project itself
name: Test Structurelint Action

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-self:
    name: Lint Structurelint Project
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build Structurelint
        run: go build -o structurelint ./cmd/structurelint/

      - name: Run Structurelint on itself
        run: ./structurelint --format json
        continue-on-error: true

      - name: Verify binary works
        run: |
          ./structurelint --version
          ./structurelint --help
          ./structurelint help graph
          ./structurelint help fix
          ./structurelint help tui
          ./structurelint help scaffold

  test-commands:
    name: Test All Commands
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build Structurelint
        run: go build -o structurelint ./cmd/structurelint/

      - name: Test graph command
        run: ./structurelint graph --format dot --output /tmp/graph.dot

      - name: Test fix command (dry-run)
        run: ./structurelint fix --dry-run

      - name: Test scaffold command (list)
        run: ./structurelint scaffold --list

      - name: Test init command
        run: |
          cd /tmp
          mkdir test-project
          cd test-project
          echo 'module example.com/test' > go.mod
          $GITHUB_WORKSPACE/structurelint --init
          cat .structurelint.yml

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run tests
        run: go test ./... -v -race -coverprofile=coverage.out

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ./coverage.out
          flags: unittests
